---
title: AWS EC2
date: 2017-03-15 20:02:03
tags: [AWS, EC2]
---
# AWS虚拟机EC2

Amazon Elastic Cloud Compute，简单来说就是亚马逊的虚拟机。
亚马逊的EC2标榜有几大优势：完全控制，灵活使用，方便集成，安全，便宜，简单好用。
关于EC2有几个重要的概念：Instance Type，即在选择Instance的时候的内存，CUP等硬件指标；然后是EBS，即挂载硬盘，租户可以选择不同IO，不同介质的虚拟硬盘；其次是AMI，即用于启动虚拟机的操作系统镜像；另外还有Security Group，可以理解为虚拟机的防火墙；其他的服务都属于附加服务，比如负载均衡，弹性伸缩，监控报警，权限控制，类似nfs的弹性存储介质等等。
虚拟机服务是云服务最重要的服务，几乎各大云厂商最终要的一项都是对租户提供虚拟机，看大厂的虚拟机策略，其他各厂基本可通晓一二。
由于企业级应用很少用windows的使用场景，笔者将主要关注在Linux的使用上，本文对windows使用场景改不涉及。

## Instances

EC2为亚马逊的服务，Instance就是该服务提供的一个实例 —— 虚拟机

### Instance Purchasing Options

在说Instance Type之前，有个更重要的东西：Instance的收费方式（Instance Purchasing Options）。Instance有四种收费方式，针对不同应用场景要学会选择适合的Purchasing Option:

 - **On-Demand Instance** 按小时收费，也是默认的收费方式，不足一小时按一小时计费；属于比较灵活的按需付费方式
 - **Reserved Instances** 预留实例，可选1-3年，一次付费，完成付费之后不管是否使用都会收费，价格相对按小时计费要便宜些，企业作为服务器长期使用通常会选择使用的付费方式
 - **Scheduled Reserved Instances** 计划预留实例，为期一年，在计划时间内可用。值得注意的是，只有几个高性能的Instance Type支持该购买方式，且每年使用不得少于1200小时，需提前三个月购买
 - **Spot Instances** 竞价实例，价格随时间浮动，租户在申请时出价，当租户出价高于该时间点竞价实例价格时，租户获得该实例使用权，当价格再次浮动导致实例价格高于租户出价，亚马逊会提前十分钟提醒租户，而后terminate实例，转移到别的地方。注意，被亚马逊销毁的实例最后一小时不收费，而用户在使用期间自行销毁的实例，不足一小时仍以一小时计费。这种收费方式适用于不需长期提供稳定服务的应用场景，比如大数据流处理。

### Instances Type
 
[Instance Type](https://aws.amazon.com/ec2/instance-types/)有10种类型，用于区分大致的应用场景，每个类型下有从nano, micro, small, medium, large, xlarge到16xlarge数目不等的型号，主要区分CPU数量，vCPU(亚马逊创造的用于衡量单个CPU运算能力的一个参数)，内存，不同，大小、类型不同，直接影响价格。

![](/images/AWS_Instances_Type.png)

 - D2 - Dense storage Instance，特点是硬盘价格平衡，支持HDD硬盘，支持EC2 Enhanced Networking，适用于对存储需求比较高的场景，比如数据库，大数据存储
 - R4: 特点是内存大
 - M4: 各项平衡的一个Instance类型，也是默认情况下首选的Instance Type
 - C4 - Compute Optimized: 计算能力优化，特点自然是计算速度快
 - G2: 包含GPU的Instance，适合于图形计算，视频转码等场景
 - I3 - High I/O Instance，高硬盘IO，使用固态硬盘，适用于非关系型数据库，大数据处理等
 - F1 - 可以为程序定制硬件加速
 - T2: 最常见的Instance使用类型，因为它最便宜，性能也最平衡，生产环境只适用于做web服务器，或小型数据库
 - P2: 通用GPU计算机，常用于人工智能等需要大量计算的领域
 - X1: CPU，内存都相当大，针对大规模，企业级，内存应用程序进行了优化，并且在Amazon EC2实例类型中具有每GiB最低的RAM价格

 Instance类型在创建后可以被更改，前提是Stop Instance
 
### Instance LifeCycle

Instance的生命周期，有pending, running, stop ,terminate几个主要的状态和动作，详见下图：

![](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/images/instance_lifecycle.png)

### MetaData & UserData

UserData是创建完成Instance最后一步用来准备Instance环境的Bash脚本，而MetaData是Instance与生俱来的元数据，通过```curl http://169.254.169.254/latest/meta-data/```这种奇特的方式获得，包含Instance类型，IP，public-key等信息。值得一提的是IAM的Role之所以在Instance的文件系统中不会出现Credential key的文件，是因为它把Credential key放到了MetaData中，可以通过获取MetaData的方式获得。

## EBS

简单来讲，EBS(Elastic Block Storage)就是AWS为租户提供的虚拟硬盘，Instance可以看做主板，EBS可以被关联到任何一个Instance上，启动Instance时也必须要一个启动硬盘作为系统盘才能启动。这里就要区分一个重要的概念，EBS 和 Instance Store，两种类型的Instance，应该说EBS Instance比Instance Store 更健全一些，支持更多的Instance Type，生命周期完整；而Instance Store，是由存放在S3的文件系统启动的，启动速度慢，生命周期不完整，只能被Reboot或者Terminate，不能Stop，一旦启动失败就会丢失所有数据，且支持类型有限，被称为短暂存储（ephemeral Storage）
下面重点区分一下[EBS Volum Type](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EBSVolumeTypes.html)，与Instance相同，重点也在使用场景和节省开销：

 - SSD, General Purporse - GP2: 

## Security Group

## Volumse & Snapshots

## AMI

## ELB & Health Checks

## Cloud Watch EC2

## Autoscaling Group

## Placement Group

## EFS

## Tips

